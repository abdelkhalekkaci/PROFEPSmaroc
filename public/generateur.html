<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="G√©n√©rez des fiches de s√©ance EPS, projets de cycle et grilles d'√©valuation conformes aux OP Maroc.">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TH0Z1SGNXH"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-TH0Z1SGNXH');</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="icon" type="image/png" href="/images/prof_eps.png">
    <title>G√©n√©rateur de Documents EPS | Prof EPS Maroc</title>
    <style>
        :root {
            --primary: #1a5c3a;
            --primary-light: #2e7d32;
            --primary-dark: #145a32;
            --accent: #f39c12;
            --bg: #f8f9fa;
            --card: #ffffff;
            --text: #2c3e50;
            --text-light: #6c757d;
            --border: #dee2e6;
            --success: #28a745;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text); }

        /* ==================== NAVBAR (identique √† home) ==================== */
        .navbar {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 15px rgba(0,0,0,0.2);
        }
        .navbar .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: white;
        }
        .navbar-brand img {
            height: 45px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .navbar-brand span {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .navbar-links {
            display: flex;
            gap: 30px;
            list-style: none;
        }
        .navbar-links a {
            color: rgba(255,255,255,0.9);
            text-decoration: none;
            font-weight: 500;
            font-size: 1rem;
            transition: 0.3s;
            padding: 8px 0;
            position: relative;
        }
        .navbar-links a:hover,
        .navbar-links a.active {
            color: var(--accent);
        }
        .navbar-links a.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent);
            border-radius: 2px;
        }
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
        }

        /* ==================== LOADING OVERLAY ==================== */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .loading-overlay.show { display: flex; }
        
        .loading-container {
            text-align: center;
        }
        .loading-spinner {
            width: 80px;
            height: 80px;
            border: 5px solid rgba(255,255,255,0.2);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 25px;
        }
        .loading-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
        }
        .loading-dots span {
            width: 12px;
            height: 12px;
            background: var(--accent);
            border-radius: 50%;
            animation: bounce 1.4s ease-in-out infinite both;
        }
        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
        .loading-dots span:nth-child(3) { animation-delay: 0s; }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .loading-text {
            color: white;
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .loading-subtext {
            color: rgba(255,255,255,0.8);
            font-size: 1rem;
        }

        /* ==================== MAIN CONTENT ==================== */
        .main-container {
            max-width: 1300px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        .page-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .page-header h1 {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 10px;
        }
        .page-header p {
            color: var(--text-light);
            font-size: 1.1rem;
        }

        /* ==================== LAYOUT ==================== */
        .generator-layout {
            display: grid;
            grid-template-columns: 420px 1fr;
            gap: 30px;
            align-items: start;
        }

        /* ==================== CARDS ==================== */
        .card {
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .card-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 18px 25px;
        }
        .card-header h2 {
            font-size: 1.15rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .card-body {
            padding: 25px;
        }

        /* ==================== TABS ==================== */
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid var(--border);
        }
        .tab {
            flex: 1;
            padding: 18px 12px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-light);
            background: none;
            border: none;
            transition: 0.3s;
        }
        .tab:hover {
            background: #e8f5e9;
            color: var(--primary);
        }
        .tab.active {
            color: var(--primary);
            background: white;
            border-bottom: 3px solid var(--primary);
            margin-bottom: -3px;
        }
        .tab-icon {
            display: block;
            font-size: 1.6rem;
            margin-bottom: 6px;
        }

        /* ==================== FORM ==================== */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text);
            margin-bottom: 8px;
        }
        .form-group label .req {
            color: #dc3545;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            transition: 0.3s;
            background: white;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 4px rgba(26,92,58,0.1);
        }
        .form-group textarea {
            min-height: 90px;
            resize: vertical;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .conditional { display: none; }
        .conditional.show { display: block; }

        .info-box {
            background: #e8f5e9;
            border-left: 4px solid var(--primary);
            padding: 15px 18px;
            border-radius: 0 10px 10px 0;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: var(--primary-dark);
        }

        /* ==================== BUTTONS ==================== */
        .btn {
            padding: 14px 25px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1rem;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            width: 100%;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(26,92,58,0.4);
        }
        .btn-primary:disabled {
            background: #adb5bd;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-success { background: var(--success); color: white; }
        .btn-accent { background: var(--accent); color: white; }
        .btn-outline { background: white; border: 2px solid var(--primary); color: var(--primary); }

        /* ==================== DETAILS TOGGLE ==================== */
        .details-toggle {
            cursor: pointer;
            color: var(--primary);
            font-weight: 600;
            font-size: 0.95rem;
            padding: 12px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            border-top: 1px solid var(--border);
            margin-top: 10px;
        }
        .details-toggle:hover { color: var(--primary-dark); }
        .details-content {
            display: none;
            padding-top: 15px;
        }
        .details-toggle.open + .details-content { display: block; }

        /* ==================== PREVIEW ==================== */
        .preview-card {
            display: flex;
            flex-direction: column;
            min-height: 650px;
        }
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .preview-actions {
            display: none;
            gap: 12px;
        }
        .preview-actions.show { display: flex; }
        .preview-actions .btn {
            padding: 12px 20px;
            font-size: 0.95rem;
        }
        .preview-content {
            flex: 1;
            padding: 25px;
            overflow: auto;
            background: #fafafa;
            border-top: 1px solid var(--border);
        }
        .preview-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            min-height: 450px;
            color: var(--text-light);
            text-align: center;
        }
        .preview-empty-icon {
            font-size: 5rem;
            opacity: 0.3;
            margin-bottom: 20px;
        }
        .preview-empty h3 {
            font-size: 1.3rem;
            color: var(--text);
            margin-bottom: 10px;
        }
        .preview-document {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        /* ==================== FOOTER (identique √† home) ==================== */
        .footer {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 40px 0 20px;
            margin-top: 60px;
        }
        .footer .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 30px;
        }
        .footer-brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .footer-brand img {
            height: 50px;
            border-radius: 10px;
        }
        .footer-brand-text strong {
            font-size: 1.3rem;
            display: block;
        }
        .footer-brand-text span {
            opacity: 0.8;
            font-size: 0.9rem;
        }
        .footer-links {
            display: flex;
            gap: 30px;
        }
        .footer-links a {
            color: rgba(255,255,255,0.85);
            text-decoration: none;
            transition: 0.3s;
            font-size: 0.95rem;
        }
        .footer-links a:hover { color: var(--accent); }
        .footer-copy {
            text-align: center;
            padding-top: 25px;
            border-top: 1px solid rgba(255,255,255,0.2);
            font-size: 0.9rem;
            opacity: 0.85;
        }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 1000px) {
            .generator-layout { grid-template-columns: 1fr; }
            .preview-card { min-height: auto; }
        }
        @media (max-width: 768px) {
            .navbar-links { display: none; }
            .mobile-menu-btn { display: block; }
            .form-row { grid-template-columns: 1fr; }
            .footer-content { flex-direction: column; align-items: center; text-align: center; }
            .footer-links { flex-wrap: wrap; justify-content: center; }
            .page-header h1 { font-size: 1.6rem; }
        }
    </style>
</head>
<body>
    <!-- NAVBAR -->
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="navbar-brand">
                <img src="/images/prof_eps.png" alt="Prof EPS" onerror="this.style.display='none'">
                <span>Prof EPS</span>
            </a>
            <ul class="navbar-links">
                <li><a href="index.html">Accueil</a></li>
                <li><a href="generateur.html" class="active">G√©n√©rateur</a></li>
                <li><a href="blog.html">Blog</a></li>
                <li><a href="a-propos.html">√Ä propos</a></li>
                <li><a href="contact.html">Contact</a></li>
            </ul>
            <button class="mobile-menu-btn">‚ò∞</button>
        </div>
    </nav>

    <!-- LOADING OVERLAY -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <div class="loading-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <div class="loading-text">‚ö° G√©n√©ration en cours...</div>
            <div class="loading-subtext">Cr√©ation de votre document personnalis√©</div>
        </div>
    </div>

    <!-- MAIN -->
    <div class="main-container">
        <div class="page-header">
            <h1>üìÑ G√©n√©rateur de Documents EPS</h1>
            <p>Cr√©ez vos fiches de s√©ance, projets de cycle et grilles d'√©valuation en quelques clics</p>
        </div>

        <div class="generator-layout">
            <!-- FORMULAIRE -->
            <div class="card">
                <div class="tabs">
                    <button class="tab active" data-type="fiche"><span class="tab-icon">üìã</span>Fiche</button>
                    <button class="tab" data-type="projet"><span class="tab-icon">üìä</span>Projet</button>
                    <button class="tab" data-type="grille"><span class="tab-icon">üìù</span>Grille</button>
                </div>
                <div class="card-body">
                    <form id="form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Niveau scolaire <span class="req">*</span></label>
                                <select id="niveau" required>
                                    <option value="">-- S√©lectionner --</option>
                                    <optgroup label="Coll√®ge">
                                        <option value="1AC">1√®re Ann√©e Coll√®ge</option>
                                        <option value="2AC">2√®me Ann√©e Coll√®ge</option>
                                        <option value="3AC">3√®me Ann√©e Coll√®ge</option>
                                    </optgroup>
                                    <optgroup label="Lyc√©e">
                                        <option value="TC">Tronc Commun</option>
                                        <option value="1AB">1√®re Ann√©e Bac</option>
                                        <option value="2AB">2√®me Ann√©e Bac</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>APS <span class="req">*</span></label>
                                <select id="aps" required>
                                    <option value="">-- S√©lectionner --</option>
                                    <optgroup label="Sports collectifs">
                                        <option value="Handball">Handball</option>
                                        <option value="Football">Football</option>
                                        <option value="Basketball">Basketball</option>
                                        <option value="Volleyball">Volleyball</option>
                                    </optgroup>
                                    <optgroup label="Athl√©tisme">
                                        <option value="Course de vitesse">Course de vitesse</option>
                                        <option value="Saut en longueur">Saut en longueur</option>
                                        <option value="Saut en hauteur">Saut en hauteur</option>
                                        <option value="Lancer de poids">Lancer de poids</option>
                                        <option value="Course de dur√©e">Course de dur√©e</option>
                                    </optgroup>
                                    <optgroup label="Gymnastique">
                                        <option value="Gymnastique">Gymnastique au sol</option>
                                    </optgroup>
                                    <optgroup label="Sports de renvoi">
                                        <option value="Tennis de table">Tennis de table</option>
                                        <option value="Badminton">Badminton</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>

                        <!-- FICHE FIELDS -->
                        <div id="ficheFields" class="conditional show">
                            <div class="form-group">
                                <label>Objectif de la s√©ance <span class="req">*</span></label>
                                <textarea id="objectif" placeholder="Ex: Am√©liorer la qualit√© de la passe en mouvement vers un partenaire d√©marqu√©"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Num√©ro de s√©ance</label>
                                <select id="numeroSeance">
                                    <option value="1">S√©ance 1</option>
                                    <option value="2">S√©ance 2</option>
                                    <option value="3">S√©ance 3</option>
                                    <option value="4">S√©ance 4</option>
                                    <option value="5">S√©ance 5</option>
                                    <option value="6">S√©ance 6</option>
                                    <option value="7">S√©ance 7</option>
                                    <option value="8">S√©ance 8</option>
                                    <option value="9">S√©ance 9</option>
                                    <option value="10">S√©ance 10</option>
                                </select>
                            </div>
                        </div>

                        <!-- PROJET FIELDS -->
                        <div id="projetFields" class="conditional">
                            <div class="info-box">
                                üìå <strong>Structure automatique :</strong> S1 = √âvaluation diagnostique | S2 = Acquisition | Derni√®re = √âvaluation terminale
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Niveau des √©l√®ves</label>
                                    <select id="niveauEleves">
                                        <option value="debutant">üü¢ D√©butant (Initiation)</option>
                                        <option value="moyen" selected>üü° Moyen (Apprentissage)</option>
                                        <option value="avance">üü† Avanc√© (Perfectionnement)</option>
                                        <option value="elite">üî¥ √âlite (Expertise)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Nombre de s√©ances</label>
                                    <select id="nombreSeances">
                                        <option value="8">8 s√©ances</option>
                                        <option value="10" selected>10 s√©ances</option>
                                        <option value="12">12 s√©ances</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- GRILLE FIELDS -->
                        <div id="grilleFields" class="conditional">
                            <div class="form-group">
                                <label>Type de grille</label>
                                <select id="typeGrille">
                                    <option value="observation">üëÅÔ∏è Grille d'observation (crit√®res techniques)</option>
                                    <option value="evaluation">üìä Grille d'√©valuation (notation /20)</option>
                                </select>
                            </div>
                        </div>

                        <!-- INFOS SUPPL√âMENTAIRES -->
                        <div class="details-toggle" id="detailsToggle">‚ûï Informations compl√©mentaires (optionnel)</div>
                        <div class="details-content" id="detailsContent">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Nom du professeur</label>
                                    <input type="text" id="nomProf" placeholder="Votre nom">
                                </div>
                                <div class="form-group">
                                    <label>√âtablissement</label>
                                    <input type="text" id="etablissement" placeholder="Nom de l'√©tablissement">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Ann√©e scolaire</label>
                                    <input type="text" id="anneeScolaire" placeholder="2024-2025">
                                </div>
                                <div class="form-group">
                                    <label>Classe (pour grille)</label>
                                    <input type="text" id="classe" placeholder="Ex: 3AC 1">
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            üöÄ G√©n√©rer le document
                        </button>
                    </form>
                </div>
            </div>

            <!-- PREVIEW -->
            <div class="card preview-card">
                <div class="card-header">
                    <div class="preview-header">
                        <h2>üìÑ Aper√ßu du document</h2>
                        <div class="preview-actions" id="previewActions">
                            <button class="btn btn-success" id="downloadWord">üì• Word</button>
                            <button class="btn btn-accent" id="downloadPdf">üì• PDF</button>
                        </div>
                    </div>
                </div>
                <div class="preview-content" id="previewContent">
                    <div class="preview-empty" id="previewEmpty">
                        <div class="preview-empty-icon">üìÑ</div>
                        <h3>Aucun document g√©n√©r√©</h3>
                        <p>Remplissez le formulaire et cliquez sur "G√©n√©rer" pour voir l'aper√ßu de votre document ici.</p>
                    </div>
                    <div class="preview-document" id="previewDocument" style="display:none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <img src="/images/prof_eps.png" alt="Prof EPS" onerror="this.style.display='none'">
                    <div class="footer-brand-text">
                        <strong>Prof EPS</strong>
                        <span>Votre assistant p√©dagogique</span>
                    </div>
                </div>
                <div class="footer-links">
                    <a href="index.html">Accueil</a>
                    <a href="generateur.html">G√©n√©rateur</a>
                    <a href="blog.html">Blog</a>
                    <a href="a-propos.html">√Ä propos</a>
                    <a href="contact.html">Contact</a>
                </div>
            </div>
            <div class="footer-copy">
                ¬© 2024 Prof EPS - Tous droits r√©serv√©s | Conforme aux Orientations P√©dagogiques du Maroc (OP 2007-2009)
            </div>
        </div>
    </footer>

    <script>
        let currentType = 'fiche';
        let currentHtml = '';
        let currentHtmlDisplay = '';
        let currentFilename = '';

        // Toggle details
        document.getElementById('detailsToggle').addEventListener('click', function() {
            this.classList.toggle('open');
        });

        // Tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentType = tab.dataset.type;
                
                document.querySelectorAll('.conditional').forEach(f => f.classList.remove('show'));
                const fields = document.getElementById(currentType + 'Fields');
                if (fields) fields.classList.add('show');
                
                clearPreview();
            });
        });

        function clearPreview() {
            document.getElementById('previewEmpty').style.display = 'flex';
            document.getElementById('previewDocument').style.display = 'none';
            document.getElementById('previewActions').classList.remove('show');
            currentHtml = '';
            currentHtmlDisplay = '';
            currentFilename = '';
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        // Form submit
        document.getElementById('form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            showLoading();
            
            try {
                const formData = {
                    typeDocument: currentType,
                    niveau: document.getElementById('niveau').value,
                    aps: document.getElementById('aps').value,
                    objectif: document.getElementById('objectif')?.value || '',
                    numeroSeance: document.getElementById('numeroSeance')?.value || '1',
                    niveauEleves: document.getElementById('niveauEleves')?.value || 'moyen',
                    nombreSeances: document.getElementById('nombreSeances')?.value || '10',
                    typeGrille: document.getElementById('typeGrille')?.value || 'observation',
                    classe: document.getElementById('classe')?.value || '',
                    nomProf: document.getElementById('nomProf')?.value || '',
                    etablissement: document.getElementById('etablissement')?.value || '',
                    anneeScolaire: document.getElementById('anneeScolaire')?.value || ''
                };
                
                const resp = await fetch('/api/generer-fiche', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const data = await resp.json();
                
                if (data.success) {
                    currentHtml = data.html;
                    currentHtmlDisplay = data.htmlDisplay || data.html;
                    currentFilename = data.filename;
                    
                    document.getElementById('previewEmpty').style.display = 'none';
                    document.getElementById('previewDocument').style.display = 'block';
                    document.getElementById('previewDocument').innerHTML = currentHtmlDisplay;
                    document.getElementById('previewActions').classList.add('show');
                } else {
                    alert('Erreur: ' + (data.error || 'Erreur inconnue'));
                }
            } catch (err) {
                alert('Erreur de connexion: ' + err.message);
            } finally {
                btn.disabled = false;
                hideLoading();
            }
        });

        // Download Word
        document.getElementById('downloadWord').addEventListener('click', () => {
            if (!currentHtml) return;
            const blob = new Blob([currentHtml], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFilename;
            a.click();
            URL.revokeObjectURL(url);
        });

        // Download PDF
        document.getElementById('downloadPdf').addEventListener('click', () => {
            if (!currentHtml) return;
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = currentHtml;
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            document.body.appendChild(tempDiv);
            
            const opt = {
                margin: 5,
                filename: currentFilename.replace('.doc', '.pdf'),
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: currentType === 'grille' ? 'portrait' : 'landscape' 
                }
            };
            
            html2pdf().set(opt).from(tempDiv).save().then(() => {
                document.body.removeChild(tempDiv);
            });
        });

        // Auto-fill
        document.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem('profeps_formData');
            if (saved) {
                try {
                    const d = JSON.parse(saved);
                    if (d.niveau) document.getElementById('niveau').value = d.niveau;
                    if (d.aps) document.getElementById('aps').value = d.aps;
                    if (d.objectif) document.getElementById('objectif').value = d.objectif;
                    if (d.nomProf) document.getElementById('nomProf').value = d.nomProf;
                    if (d.etablissement) document.getElementById('etablissement').value = d.etablissement;
                    if (d.anneeScolaire) document.getElementById('anneeScolaire').value = d.anneeScolaire;
                    if (d.numeroSeance) document.getElementById('numeroSeance').value = d.numeroSeance;
                    localStorage.removeItem('profeps_formData');
                    if (d.autoGenerate) {
                        setTimeout(() => document.getElementById('form').dispatchEvent(new Event('submit')), 500);
                    }
                } catch (e) {
                    localStorage.removeItem('profeps_formData');
                }
            }
        });
    </script>
</body>
</html>
